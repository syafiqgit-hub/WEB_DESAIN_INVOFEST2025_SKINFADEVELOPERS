<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analisis Keuangan - Cerdas Finansial</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
         :root {
            --primary-color: #f35b04;
            --secondary-color: #ed8a07;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-muted: #666666;
            --border-color: #e9ecef;
            --shadow: rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --text-muted: #cccccc;
            --border-color: #404040;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        [data-theme="dark"] body,
        [data-theme="dark"] body h1,
        [data-theme="dark"] body h2,
        [data-theme="dark"] body h3,
        [data-theme="dark"] body h4,
        [data-theme="dark"] body h5,
        [data-theme="dark"] body h6,
        [data-theme="dark"] body p,
        [data-theme="dark"] body a,
        [data-theme="dark"] body span,
        [data-theme="dark"] body label,
        [data-theme="dark"] .card,
        [data-theme="dark"] .card-header,
        [data-theme="dark"] .container,
        [data-theme="dark"] .table,
        [data-theme="dark"] .table th,
        [data-theme="dark"] .table td {
            color: var(--text-color) !important;
        }
        
        [data-theme="dark"] .form-control,
        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: "Poppins", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .hero {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 50px 30px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 40px;
            box-shadow: 0 5px 20px var(--shadow);
            animation: fadeInUp 0.8s ease-out;
        }
        
        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .hero p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 0;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px var(--shadow);
            margin-bottom: 30px;
            background-color: var(--card-bg);
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow);
        }
        
        .card-header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            padding: 20px 25px;
            border-radius: 15px 15px 0 0 !important;
            font-size: 1.2rem;
        }
        
        .analysis-table {
            width: 100%;
            margin-bottom: 0;
        }
        
        .analysis-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border: none;
        }
        
        .analysis-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        .metric-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 15px;
        }
        
        .metric-icon.wallet {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }
        
        .metric-icon.expenses {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        
        .metric-icon.balance {
            background: rgba(23, 162, 184, 0.1);
            color: #17a2b8;
        }
        
        .metric-icon.target {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .summary-card {
            background: linear-gradient(135deg, rgba(243, 91, 4, 0.05), rgba(237, 138, 7, 0.05));
            border: 1px solid rgba(243, 91, 4, 0.08);
        }
        
        .summary-card .card-header {
            background: transparent;
            border-bottom: none;
            color: var(--primary-color);
        }
        
        .insight-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
        }
        
        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1rem;
        }
        
        .insight-icon.positive {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }
        
        .insight-icon.warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        
        .insight-icon.info {
            background: rgba(23, 162, 184, 0.2);
            color: #17a2b8;
        }
        
        .progress-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0 auto 10px;
            position: relative;
            background: #e9ecef;
        }
        
        .progress-circle span {
            position: relative;
            z-index: 1;
            color: var(--primary-color);
        }
        
        .btn-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 500;
            transition: var(--transition);
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 91, 4, 0.3);
            color: white;
        }
        
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 2px 10px var(--shadow);
            transition: var(--transition);
        }
        
        .dark-mode-toggle:hover {
            transform: scale(1.1);
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            transform: translateX(-100%);
            transition: var(--transition);
            z-index: 1000;
            box-shadow: 2px 0 10px var(--shadow);
        }
        
        .sidebar.show {
            transform: translateX(0);
        }
        
        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .sidebar-header h3 {
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .sidebar .sidebar-header .header-logo {
            max-width: 160px;
            width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 10px;
            object-fit: contain;
        }
        
        @media (max-width: 768px) {
            .sidebar .sidebar-header .header-logo {
                max-width: 220px;
            }
        }
        
        .sidebar-nav {
            list-style: none;
            padding: 0;
        }
        
        .sidebar-nav li {
            margin-bottom: 10px;
        }
        
        .sidebar-nav a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 10px 15px;
            border-radius: 5px;
            transition: var(--transition);
        }
        
        .sidebar-nav a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 2px 10px var(--shadow);
            transition: var(--transition);
        }
        
        .sidebar-toggle:hover {
            transform: scale(1.1);
        }
        
        .main-content {
            margin-left: 0;
            transition: var(--transition);
        }
        
        .main-content.shifted {
            margin-left: 250px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 50px;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            .analysis-table th,
            .analysis-table td {
                padding: 10px;
                font-size: 0.9rem;
            }
            .metric-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
                margin-right: 10px;
            }
            .metric-value {
                font-size: 1.2rem;
            }
            .container {
                padding: 20px 15px;
            }
        }
        
        @media (min-width: 769px) {
            .sidebar-toggle {
                display: none;
            }
            .sidebar {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 250px;
            }
        }
        
        #tips {
            margin: 20px auto;
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            transition: 0.3s ease;
        }
        
        #tips .card-header {
            font-weight: 600;
            font-size: 1.1rem;
            background: #f35b04;
            color: white;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        #tips .card-body {
            padding: 15px 20px;
        }
        
        #tips .btn-custom {
            color: white;
            border: none;
        }
        
        @media (max-width: 768px) {
            #tips .card-body {
                flex-direction: column;
                align-items: stretch;
                text-align: left;
            }
            #tips .tip-buttons {
                margin-top: 12px;
                text-align: left;
            }
            #tips .tip-buttons button {
                width: 48%;
                font-size: 0.9rem;
            }
            #tips .tip-buttons #next-tip {
                margin-left: 4%;
            }
        }
        
        @media (max-width: 480px) {
            #tips .card-header {
                font-size: 1rem;
            }
            #tips .tip-buttons button {
                width: 100%;
                margin-bottom: 8px;
            }
            #tips .tip-buttons #next-tip {
                margin-left: 0;
            }
        }
        
        .card-body {
            overflow-x: auto;
        }
        
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        .analysis-table th,
        .analysis-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            .analysis-table th,
            .analysis-table td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <button class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <button class="dark-mode-toggle" id="dark-mode-toggle">
        <i class="fas fa-moon"></i>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../assets/media/logo-dashboard.png" alt="Cerdas Finansial logo" class="header-logo" />
        </div>
        <ul class="sidebar-nav">
            <li><a href="index.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="analisis-keuangan.html"><i class="fas fa-chart-pie"></i> Analisis Keuangan</a></li>
        </ul>
    </div>

    <div class="main-content" id="main-content">
        <div class="container-fluid my-4">
            <div class="hero" id="hero" style="text-align: left;">
                <h1>ðŸ“Š Analisis Keuangan</h1>
                <p>Ringkasan lengkap kondisi keuangan Anda saat ini</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i> Ringkasan Keuangan
                </div>
                <div class="card-body">
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                <th>Kategori</th>
                                <th>Nilai</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="metric-icon wallet">
                                            <i class="fas fa-coins"></i>
                                        </div>
                                        <div>
                                            <strong>Total Saldo</strong>
                                            <br />
                                            <small class="text-muted">Dompet + Tabungan</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="metric-value" id="total-balance">Rp 0</td>
                                <td>
                                    <span class="badge bg-success" id="balance-status">Baik</span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="metric-icon expenses">
                                            <i class="fas fa-credit-card"></i>
                                        </div>
                                        <div>
                                            <strong>Pengeluaran Bulanan</strong>
                                            <br />
                                            <small class="text-muted">Total pengeluaran bulan ini</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="metric-value" id="monthly-expenses">Rp 0</td>
                                <td>
                                    <span class="badge bg-warning" id="expense-status">Normal</span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="metric-icon balance">
                                            <i class="fas fa-balance-scale"></i>
                                        </div>
                                        <div>
                                            <strong>Sisa Keuangan</strong>
                                            <br />
                                            <small class="text-muted">Saldo setelah pengeluaran</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="metric-value" id="remaining-balance">Rp 0</td>
                                <td>
                                    <span class="badge bg-info" id="remaining-status">Netral</span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="metric-icon target">
                                            <i class="fas fa-bullseye"></i>
                                        </div>
                                        <div>
                                            <strong>Pencapaian Target</strong>
                                            <br />
                                            <small class="text-muted">Progress menuju target</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="metric-value" id="target-achievement">0%</td>
                                <td>
                                    <div class="progress-circle" id="target-progress">
                                        <span id="target-percent">0%</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card summary-card">
                <div class="card-header">
                    <i class="fas fa-lightbulb"></i> Wawasan & Rekomendasi
                </div>
                <div class="card-body">
                    <div id="insights-container">
                        <div class="insight-item">
                            <div class="insight-icon info">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div>
                                <strong>Memuat analisis...</strong>
                                <br />
                                <small>Sedang menghitung kondisi keuangan Anda</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <div class="text-center">
                <a href="index.html" class="btn-custom">
                    <i class="fas fa-tachometer-alt"></i> Lihat Dashboard Lengkap
                </a>
            </div>
        </div>

        <footer>
            Â© 2025 All Rights Reserved Cerdas Finansial. Dibuat Oleh Skinfa Developers
        </footer>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            (function() {
                'use strict';

                const LS_KEY = 'cf_dashboard_data_v1';

                const DEFAULT_DATA = {
                    wallet: 0,
                    savings: 0,
                    expenses: 0,
                    target: 0,
                    theme: 'light',
                    notifications: [],
                    goals: []
                };

                const TIPS = [{
                    text: 'Catat semua pengeluaran harian selama seminggu untuk menemukan pengeluaran tersembunyi.',
                    source: 'Manajemen Pengeluaran'
                }, {
                    text: 'Sisihkan minimal 10% dari pemasukan untuk tabungan darurat.',
                    source: 'Menabung Cerdas'
                }, {
                    text: 'Periksa langganan berulang; hentikan yang jarang dipakai untuk menghemat.',
                    source: 'Optimalisasi'
                }, {
                    text: 'Buat target jangka pendek dengan nominal dan tanggal waktu agar lebih realistis.',
                    source: 'Perencanaan'
                }, {
                    text: 'Alokasikan sebagian tabungan ke investasi rutin untuk memanfaatkan compounding.',
                    source: 'Investasi'
                }, {
                    text: 'Prioritaskan bayar utang berbunga tinggi sebelum menambah investasi.',
                    source: 'Manajemen Utang'
                }, {
                    text: 'Gunakan anggaran 50/30/20 jika belum punya alokasi pengeluaran yang jelas.',
                    source: 'Budgeting'
                }];

                const currencyFormatter = new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    maximumFractionDigits: 0
                });

                function formatCurrency(v) {
                    const n = Number(v) || 0;
                    return currencyFormatter.format(Math.round(n));
                }

                function loadData() {
                    try {
                        const raw = localStorage.getItem(LS_KEY);
                        if (!raw) return structuredClone(DEFAULT_DATA);
                        const parsed = JSON.parse(raw);
                        return Object.assign(structuredClone(DEFAULT_DATA), parsed);
                    } catch (e) {
                        console.warn('Gagal membaca localStorage, gunakan default.', e);
                        return structuredClone(DEFAULT_DATA);
                    }
                }

                function saveData(d) {
                    try {
                        localStorage.setItem(LS_KEY, JSON.stringify(d));
                    } catch (e) {
                        console.error('Gagal menyimpan data', e);
                    }
                }

                function $(id) {
                    return document.getElementById(id);
                }

                const refs = {
                    totalBalance: $('total-balance'),
                    monthlyExpenses: $('monthly-expenses'),
                    remainingBalance: $('remaining-balance'),
                    balanceStatus: $('balance-status'),
                    expenseStatus: $('expense-status'),
                    remainingStatus: $('remaining-status'),
                    targetAchievement: $('target-achievement'),
                    targetPercentSpan: $('target-percent'),
                    targetProgressCircle: $('target-progress'),
                    insightsContainer: $('insights-container'),
                    analysisTip: $('analysis-tip'),
                    analysisTipSource: $('analysis-tip-source'),
                    nextTipBtn: $('next-analysis-tip'),
                    prevTipBtn: $('prev-analysis-tip')
                };

                function computeTargetAchievement(data) {
                    if (Array.isArray(data.goals) && data.goals.length > 0) {
                        const totalTarget = data.goals.reduce((s, g) => s + (Number(g.targetAmount) || 0), 0);
                        const totalSaved = data.goals.reduce((s, g) => s + (Number(g.saved) || 0), 0);
                        if (totalTarget <= 0) return 0;
                        return Math.min(100, Math.round((totalSaved / totalTarget) * 100));
                    }
                    if (Number(data.target) > 0) {
                        const totalAssets = (Number(data.wallet) || 0) + (Number(data.savings) || 0);
                        return Math.min(100, Math.round((totalAssets / Number(data.target)) * 100));
                    }
                    return 0;
                }

                function analyze(data) {
                    const wallet = Number(data.wallet) || 0;
                    const savings = Number(data.savings) || 0;
                    const expenses = Number(data.expenses) || 0;
                    const target = Number(data.target) || 0;

                    const totalBalance = wallet + savings;
                    const remaining = totalBalance - expenses;

                    let balanceStatus = {
                        text: 'Baik',
                        class: 'bg-success'
                    };
                    if (totalBalance <= 0) balanceStatus = {
                        text: 'Kritis',
                        class: 'bg-danger'
                    };
                    else {
                        const remRatio = remaining / totalBalance;
                        if (remRatio >= 0.5) balanceStatus = {
                            text: 'Baik',
                            class: 'bg-success'
                        };
                        else if (remRatio >= 0.2) balanceStatus = {
                            text: 'Waspada',
                            class: 'bg-warning'
                        };
                        else balanceStatus = {
                            text: 'Kritis',
                            class: 'bg-danger'
                        };
                    }

                    let expenseStatus = {
                        text: 'Normal',
                        class: 'bg-success'
                    };
                    if (totalBalance <= 0) {
                        if (expenses === 0) expenseStatus = {
                            text: 'Tidak Ada',
                            class: 'bg-info'
                        };
                        else expenseStatus = {
                            text: 'Perhatian',
                            class: 'bg-warning'
                        };
                    } else {
                        const expRatio = expenses / totalBalance;
                        if (expRatio <= 0.3) expenseStatus = {
                            text: 'Normal',
                            class: 'bg-success'
                        };
                        else if (expRatio <= 0.6) expenseStatus = {
                            text: 'Sedang',
                            class: 'bg-warning'
                        };
                        else expenseStatus = {
                            text: 'Tinggi',
                            class: 'bg-danger'
                        };
                    }

                    let remainingStatus = {
                        text: 'Netral',
                        class: 'bg-info'
                    };
                    if (remaining < 0) remainingStatus = {
                        text: 'Negatif',
                        class: 'bg-danger'
                    };
                    else if (remaining === 0) remainingStatus = {
                        text: 'Nol',
                        class: 'bg-warning'
                    };
                    else remainingStatus = {
                        text: 'Positif',
                        class: 'bg-info'
                    };

                    const percent = computeTargetAchievement(data);

                    return {
                        wallet,
                        savings,
                        expenses,
                        target,
                        totalBalance,
                        remaining,
                        percent,
                        balanceStatus,
                        expenseStatus,
                        remainingStatus
                    };
                }

                function setBadge(el, text, variantClass) {
                    if (!el) return;
                    el.textContent = text;
                    el.classList.remove('bg-success', 'bg-warning', 'bg-danger', 'bg-info', 'bg-secondary', 'bg-primary', 'bg-dark', 'bg-light');
                    if (variantClass) el.classList.add(variantClass);
                }

                function escapeHtml(s) {
                    return String(s || '')
                        .replaceAll('&', '&amp;')
                        .replaceAll('<', '&lt;')
                        .replaceAll('>', '&gt;')
                        .replaceAll('"', '&quot;')
                        .replaceAll("'", '&#039;');
                }

                function ensureTipIndex(data) {
                    if (!data.tips) data.tips = {
                        index: null
                    };
                    if (Number.isInteger(data.tips.index)) return;
                    const now = new Date();
                    const start = new Date(now.getFullYear(), 0, 0);
                    const diff = now - start;
                    const oneDay = 1000 * 60 * 60 * 24;
                    const dayOfYear = Math.floor(diff / oneDay);
                    data.tips.index = dayOfYear % TIPS.length;
                    saveData(data);
                }

                function showTipAtIndex(idx, data) {
                    const i = ((idx % TIPS.length) + TIPS.length) % TIPS.length;
                    data.tips = data.tips || {};
                    data.tips.index = i;
                    saveData(data);
                    const tip = TIPS[i];
                    if (refs.analysisTip) refs.analysisTip.textContent = tip.text;
                    if (refs.analysisTipSource) refs.analysisTipSource.textContent = 'Sumber: ' + tip.source;
                }

                function nextTip() {
                    const data = loadData();
                    ensureTipIndex(data);
                    showTipAtIndex((data.tips.index || 0) + 1, data);
                }

                function prevTip() {
                    const data = loadData();
                    ensureTipIndex(data);
                    showTipAtIndex((data.tips.index || 0) - 1, data);
                }

                function setProgressCircle(el, percent) {
                    if (!el) return;
                    const deg = Math.max(0, Math.min(100, percent)) * 3.6;
                    el.style.background = `conic-gradient(var(--primary-color) ${deg}deg, #e9ecef ${deg}deg)`;
                }

                function buildInsights(res, data) {
                    const out = [];
                    if (res.totalBalance <= 0) {
                        out.push({
                            title: 'Saldo kosong atau negatif',
                            detail: 'Dompet + tabungan kosong. Prioritaskan menambah dana darurat.',
                            iconClass: 'fas fa-exclamation-triangle',
                            iconVariant: 'warning'
                        });
                    } else if (res.remaining < 0) {
                        out.push({
                            title: 'Pengeluaran melebihi aset',
                            detail: 'Pengeluaran bulan ini lebih besar dari aset Anda. Kurangi pengeluaran tidak penting.',
                            iconClass: 'fas fa-chart-line',
                            iconVariant: 'warning'
                        });
                    } else {
                        out.push({
                            title: 'Posisi likuid positif',
                            detail: 'Aset cukup untuk menutup pengeluaran. Pertahankan kebiasaan menabung.',
                            iconClass: 'fas fa-thumbs-up',
                            iconVariant: 'positive'
                        });
                    }

                    if (res.totalBalance > 0) {
                        const ratio = Math.round((res.expenses / res.totalBalance) * 100);
                        if (ratio > 60) {
                            out.push({
                                title: 'Pengeluaran tinggi terhadap aset',
                                detail: `Pengeluaran sekitar ${ratio}% dari aset Anda. Periksa kategori terbesar.`,
                                iconClass: 'fas fa-credit-card',
                                iconVariant: 'warning'
                            });
                        } else if (ratio > 30) {
                            out.push({
                                title: 'Pengeluaran sedang',
                                detail: `Pengeluaran sekitar ${ratio}% dari aset. Pantau pengeluaran mingguan.`,
                                iconClass: 'fas fa-eye',
                                iconVariant: 'info'
                            });
                        } else {
                            out.push({
                                title: 'Pengeluaran terkendali',
                                detail: `Pengeluaran sekitar ${ratio}% dari aset. Bagus, pertahankan pola ini.`,
                                iconClass: 'fas fa-check-circle',
                                iconVariant: 'positive'
                            });
                        }
                    }

                    if (Array.isArray(data.goals) && data.goals.length > 0) {
                        const short = data.goals.slice(0, 3).map(g => `${g.title} (${Math.min(100, Math.round((g.saved / g.targetAmount) * 100 || 0))}%)`).join(', ');
                        out.push({
                            title: 'Ringkasan Target',
                            detail: `Tiga target teratas: ${short}`,
                            iconClass: 'fas fa-bullseye',
                            iconVariant: 'info'
                        });
                    } else {
                        out.push({
                            title: 'Belum ada target terdaftar',
                            detail: 'Tambahkan target pada dashboard agar progress dapat terpantau.',
                            iconClass: 'fas fa-bullseye',
                            iconVariant: 'info'
                        });
                    }

                    return out;
                }

                function renderAll() {
                    const data = loadData();
                    renderTheme(data.theme);
                    const r = analyze(data);

                    if (refs.totalBalance) refs.totalBalance.textContent = formatCurrency(r.totalBalance);
                    if (refs.monthlyExpenses) refs.monthlyExpenses.textContent = formatCurrency(r.expenses);
                    if (refs.remainingBalance) refs.remainingBalance.textContent = formatCurrency(r.remaining);

                    setBadge(refs.balanceStatus, r.balanceStatus.text, r.balanceStatus.class);
                    setBadge(refs.expenseStatus, r.expenseStatus.text, r.expenseStatus.class);
                    setBadge(refs.remainingStatus, r.remainingStatus.text, r.remainingStatus.class);

                    if (refs.targetAchievement) refs.targetAchievement.textContent = `${r.percent}%`;
                    if (refs.targetPercentSpan) refs.targetPercentSpan.textContent = `${r.percent}%`;
                    setProgressCircle(refs.targetProgressCircle, r.percent);

                    if (refs.insightsContainer) {
                        refs.insightsContainer.innerHTML = '';
                        const insights = buildInsights(r, data);
                        insights.forEach(i => {
                            const item = document.createElement('div');
                            item.className = 'insight-item';
                            item.innerHTML = `
                                <div class="insight-icon ${i.iconVariant}"><i class="${i.iconClass}"></i></div>
                                <div>
                                    <strong>${escapeHtml(i.title)}</strong><br>
                                    <small class="text-muted">${escapeHtml(i.detail)}</small>
                                </div>
                            `;
                            refs.insightsContainer.appendChild(item);
                        });
                    }

                    ensureTipIndex(data);
                    showTipAtIndex(data.tips.index || 0, data);
                }

                function renderTheme(theme) {
                    if (theme === 'dark') {
                        document.documentElement.setAttribute('data-theme', 'dark');
                        const dm = document.getElementById('dark-mode-toggle');
                        if (dm) dm.querySelector('i').className = 'fas fa-sun';
                    } else {
                        document.documentElement.removeAttribute('data-theme');
                        const dm = document.getElementById('dark-mode-toggle');
                        if (dm) dm.querySelector('i').className = 'fas fa-moon';
                    }
                }

                function attachListeners() {
                    const dm = document.getElementById('dark-mode-toggle');
                    if (dm) {
                        dm.addEventListener('click', () => {
                            const d = loadData();
                            d.theme = d.theme === 'dark' ? 'light' : 'dark';
                            saveData(d);
                            renderTheme(d.theme);
                        });
                    }

                    const st = document.getElementById('sidebar-toggle');
                    const sidebar = document.getElementById('sidebar');
                    const main = document.getElementById('main-content');
                    if (st && sidebar && main) {
                        st.addEventListener('click', () => {
                            sidebar.classList.toggle('show');
                            main.classList.toggle('shifted');
                        });
                    }

                    if (refs.nextTipBtn) refs.nextTipBtn.addEventListener('click', () => nextTip());
                    if (refs.prevTipBtn) refs.prevTipBtn.addEventListener('click', () => prevTip());

                    window.addEventListener('storage', (e) => {
                        if (e.key === LS_KEY) renderAll();
                    });

                    window.addEventListener('focus', renderAll);

                    setInterval(() => {
                        const d = loadData();
                        const now = new Date();
                        const start = new Date(now.getFullYear(), 0, 0);
                        const diff = now - start;
                        const oneDay = 1000 * 60 * 60 * 24;
                        const dayOfYear = Math.floor(diff / oneDay);
                        const newIdx = dayOfYear % TIPS.length;
                        if (!d.tips) d.tips = {
                            index: null
                        };
                        if (d.tips.index !== newIdx) {
                            d.tips.index = newIdx;
                            saveData(d);
                            showTipAtIndex(newIdx, d);
                        }
                    }, 1000 * 60 * 60);
                }

                function init() {
                    renderAll();
                    attachListeners();
                }

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', init);
                } else {
                    init();
                }

                window.cfAnalysis = {
                    render: renderAll,
                    nextTip,
                    prevTip,
                    getData: loadData,
                    saveData
                };

            })();
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const isLoggedIn = localStorage.getItem("isLoggedIn");
                if (isLoggedIn !== "true") {
                    window.location.href = "../login.html";
                }
            });
        </script>
</body>

</html>